# Executor Agent - Trading Execution

## Overview

The Executor Agent executes trading plans generated by the Planner Agent. It connects to OKX via WebSocket and places market orders based on the plan's action (BUY/SELL/HOLD) and confidence level.

## Architecture

```
Data Agent → Analysis Agents → Planner Agent → Executor Agent
                                     ↓                ↓
                                plan.ready     execution.{symbol}
                                     ↓                ↓
                               [Executor]      [Event Bus]
                                     ↓
                                [OKX API]
```

## Features

✅ **WebSocket Trading**: Real-time order execution via OKX WebSocket
✅ **Demo Mode**: Safe testing with simulated trading account
✅ **Confidence-Based Sizing**: Order size scales with plan confidence (0.5-1.0)
✅ **Safety Switch**: Must explicitly enable trading in config
✅ **OpenTelemetry**: Full distributed tracing for execution flow
✅ **Error Handling**: Graceful fallback and error reporting

## Configuration

### loom.toml

```toml
[agents.executor-agent]
topics = ["plan.ready"]
enable_trading = false  # Safety switch - set to true to enable
min_order_size = 0.001  # Minimum order size in BTC
max_order_size = 0.01   # Maximum order size in BTC
```

### .env

```bash
# OKX Trading API Credentials
OKX_API_KEY='your-api-key'
OKX_SECRET_KEY='your-secret-key'
OKX_PASSPHRASE='your-passphrase'

# Trading Mode (true = demo, false = production)
OKX_USE_DEMO='true'
```

## Order Size Calculation

Order size is calculated based on plan confidence:

| Confidence | Order Size | Example (0.001-0.01 BTC range) |
| ---------- | ---------- | ------------------------------ |
| 50%        | Min        | 0.001 BTC                      |
| 60%        | 28%        | 0.0028 BTC                     |
| 70%        | 46%        | 0.0046 BTC                     |
| 80%        | 64%        | 0.0064 BTC                     |
| 90%        | 82%        | 0.0082 BTC                     |
| 100%       | Max        | 0.01 BTC                       |

Formula: `size = min_size + (max_size - min_size) * ((confidence - 0.5) * 2)`

## Trading Flow

1. **Listen**: Subscribe to `plan.ready` topic
2. **Parse**: Extract action, confidence, reasoning from plan
3. **Calculate**: Determine order size based on confidence
4. **Execute**: Place market order via OKX WebSocket
5. **Emit**: Send execution result to `execution.{symbol}` topic

## Plan Format (Input)

```json
{
  "symbol": "BTC",
  "action": "BUY",           // BUY, SELL, or HOLD
  "confidence": 0.85,        // 0.0 - 1.0
  "reasoning": "Strong uptrend with bullish sentiment",
  "sources": {
    "trend": {...},
    "risk": {...},
    "sentiment": {...}
  }
}
```

## Execution Result Format (Output)

```json
{
  "symbol": "BTC",
  "plan_action": "BUY",
  "plan_confidence": 0.85,
  "executed": true,
  "status": "success", // success, error, hold, skipped
  "order_id": "123456789",
  "order_size": 0.0082,
  "message": "Order placed: BUY 0.0082 BTC-USDT",
  "execution_time_ms": 1700000000000
}
```

## Safety Features

### 1. Trading Disabled by Default

```toml
enable_trading = false  # Must explicitly set to true
```

### 2. Demo Mode by Default

```bash
OKX_USE_DEMO='true'  # Use demo account for testing
```

### 3. Order Size Limits

```toml
min_order_size = 0.001  # Minimum position size
max_order_size = 0.01   # Maximum position size
```

### 4. Position Sizing Based on Confidence

Lower confidence → smaller position → reduced risk

## Testing

### Dry Run Test (No Connection)

```bash
python3 test_executor.py
```

### Enable Trading (Demo Mode)

1. Set `enable_trading = true` in loom.toml
2. Ensure `OKX_USE_DEMO='true'` in .env
3. Run full system: `loom run`

### Enable Production Trading (⚠️ Real Money)

1. Set `enable_trading = true` in loom.toml
2. Set `OKX_USE_DEMO='false'` in .env
3. **Carefully review configuration**
4. Run: `loom run`

## Monitoring

### Logs

- `[executor]` prefix shows execution activity
- `SIMULATED` when trading disabled
- `EXECUTED` when orders placed
- `ERROR` for failures

### Jaeger Traces

- Span: `executor.on_plan_event` - Plan received
- Span: `executor.execute_plan` - Execution logic
- Attributes: action, confidence, status, order_id

### Events

- Subscribe to: `plan.ready`
- Publish to: `execution.{symbol}` (e.g., `execution.btc`)

## Error Handling

| Error            | Behavior                                      |
| ---------------- | --------------------------------------------- |
| Trading disabled | Log "SIMULATED", return status="skipped"      |
| Not connected    | Log error, return status="error"              |
| Order failed     | Log error, return status="error" with message |
| Unknown action   | Log error, return status="error"              |

## OKX WebSocket API

### Authentication

- Login with API Key, Secret, Passphrase
- HMAC-SHA256 signature
- Timestamp-based signing

### Order Placement

```json
{
  "id": "order_1",
  "op": "order",
  "args": [
    {
      "instId": "BTC-USDT",
      "tdMode": "cash", // Spot trading
      "side": "buy", // buy or sell
      "ordType": "market", // Market order
      "sz": "0.001" // Size in base currency
    }
  ]
}
```

### Response

```json
{
  "id": "order_1",
  "op": "order",
  "code": "0", // "0" = success
  "msg": "",
  "data": [
    {
      "ordId": "123456789",
      "clOrdId": "",
      "sCode": "0",
      "sMsg": ""
    }
  ]
}
```

## Next Steps

1. ✅ Test in simulation mode (`enable_trading=false`)
2. ✅ Enable trading in demo mode (`enable_trading=true`, `OKX_USE_DEMO='true'`)
3. ✅ Monitor execution in logs and Jaeger
4. ✅ Verify orders in OKX demo account
5. ⚠️ Consider production trading (real money at risk)

## Troubleshooting

### Trading Not Executing

- Check `enable_trading=true` in loom.toml
- Verify API credentials in .env
- Check connection logs for authentication errors

### Orders Failing

- Verify sufficient balance in account
- Check minimum order size for instrument
- Review OKX API error messages in logs

### Wrong Trading Mode

- Verify `OKX_USE_DEMO` in .env
- Check WebSocket URL in logs (wspap = demo, ws = production)
- Confirm balance matches expected mode

## Support

- OKX API Docs: https://www.okx.com/docs-v5/en/
- Loom Docs: See /docs directory
- Issues: Report via GitHub
