syntax = "proto3";

package loom.v1;

import "event.proto";

// Provider type for a capability/tool
enum ProviderKind {
  PROVIDER_NATIVE = 0;  // In-process Rust
  PROVIDER_WASM = 1;    // In-process WASM
  PROVIDER_GRPC = 2;    // Out-of-process gRPC
  PROVIDER_MCP = 3;     // Model Context Protocol adapter
}

// Capability (tool/action) descriptor
message CapabilityDescriptor {
  string name = 1;                 // e.g., "tts.speak", "ui.update"
  string version = 2;              // semantic version of capability
  ProviderKind provider = 3;       // provider type
  map<string, string> metadata = 4; // arbitrary metadata (schemas, limits, etc.)
}

// Action invocation request
message ActionCall {
  string id = 1;                   // unique id for this call (idempotency key)
  string capability = 2;           // capability name to invoke
  string version = 3;              // desired capability version (optional)
  bytes payload = 4;               // opaque payload (JSON or binary as agreed)
  map<string, string> headers = 5; // auxiliary info (trace, auth, etc.)
  int64 timeout_ms = 6;            // hard timeout for the call
  string correlation_id = 7;       // ties back to task/session/event chain
  QoSLevel qos = 8;                // desired QoS semantics
}

// Error payload for failed actions
message ActionError {
  string code = 1;                 // machine-readable error code
  string message = 2;              // human-readable message
  map<string, string> details = 3; // optional details
}

// Action invocation result
message ActionResult {
  string id = 1;                   // matches ActionCall.id
  ActionStatus status = 2;         // final status of the call
  bytes output = 3;                // result payload (if any)
  ActionError error = 4;           // error details (if any)
}

// Final status of an action invocation
enum ActionStatus {
  ACTION_OK = 0;
  ACTION_ERROR = 1;
  ACTION_TIMEOUT = 2;
  ACTION_RETRYABLE = 3; // transient error, eligible for retry
}

// Service surface for out-of-process providers (optional)
service ActionBroker {
  rpc ListCapabilities(ListCapabilitiesRequest) returns (ListCapabilitiesResponse);
  rpc Invoke(ActionCall) returns (ActionResult);
}

message ListCapabilitiesRequest {}

message ListCapabilitiesResponse {
  repeated CapabilityDescriptor capabilities = 1;
}
